FROM denoland/deno:2.0.6 AS base
WORKDIR /app
RUN chown 1000:1000 .


# Copy root files
COPY --chown=1000:1000 package.json deno.json deno.lock ./

# Copy package.jsons from packages
COPY --chown=1000:1000 packages/backend/package.json packages/backend/package.json
COPY --chown=1000:1000 packages/frontend/package.json packages/frontend/package.json
COPY --chown=1000:1000 packages/types/package.json packages/types/package.json

# Copy deno.jsons from packages
COPY --chown=1000:1000 packages/backend/deno.json packages/backend/deno.json
COPY --chown=1000:1000 packages/frontend/deno.json packages/frontend/deno.json
COPY --chown=1000:1000 packages/types/deno.json packages/types/deno.json

# Install node_modules
RUN deno install --allow-scripts

# Copy package sources
COPY --chown=1000:1000 packages packages
COPY --chown=1000:1000 scripts scripts
